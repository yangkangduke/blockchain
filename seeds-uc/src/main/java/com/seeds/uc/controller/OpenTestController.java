package com.seeds.uc.controller;


import cn.hutool.json.JSON;
import com.seeds.admin.dto.response.SysNftDetailResp;
import com.seeds.admin.enums.NftStatusEnum;
import com.seeds.admin.feign.RemoteNftService;
import com.seeds.common.dto.GenericDto;
import com.seeds.common.web.context.UserContext;
import com.seeds.uc.dto.request.NFTBuyReq;
import com.seeds.uc.enums.UcErrorCodeEnum;
import com.seeds.uc.exceptions.GenericException;
import com.seeds.uc.service.IUcUserAccountService;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.kafka.support.SendResult;
import org.springframework.util.concurrent.ListenableFuture;
import org.springframework.util.concurrent.ListenableFutureCallback;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.math.BigDecimal;
import java.util.Objects;

/**
 * <p>
 * test 前端控制器
 * </p>
 *
 * @author yk
 * @since 2022-08-19
 */
@RestController
@RequestMapping("/test")
@Api(tags = "test")
@Slf4j
public class OpenTestController {

    @Autowired
    private KafkaTemplate kafkaTemplate;

    /**
     * 发送消息
     * @return
     */
    @GetMapping("/send")
    public Object send() {
        try {
            ListenableFuture<SendResult> listenableFuture = kafkaTemplate.send("test_topic", "发送一个测试消息");
            // 提供回调方法，可以监控消息的成功或失败的后续处理
            listenableFuture.addCallback(new ListenableFutureCallback<SendResult>() {
                @Override
                public void onFailure(Throwable throwable) {
                    log.info("发送消息失败，" + throwable.getMessage());
                }
                @Override
                public void onSuccess(SendResult sendResult) {
                    // 消息发送到的topic
                    String topic = sendResult.getRecordMetadata().topic();
                    // 消息发送到的分区
                    int partition = sendResult.getRecordMetadata().partition();
                    // 消息在分区内的offset
                    long offset = sendResult.getRecordMetadata().offset();
                    log.info(String.format("发送消息成功，topc：%s, partition: %s, offset：%s ", topic, partition, offset));
                }
            });

            return "消息发送成功";
        } catch (Exception e) {
            e.printStackTrace();
            return "消息发送失败";
        }
    }

    /**
     * 监听消息
     * @param content
     */
    @KafkaListener(topics = "test_topic", groupId = "tomge-consumer-group")
    public void receiveMesage(String content) {
        log.info("消费消息：" + content);
    }

}
